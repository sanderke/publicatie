<!DOCTYPE html><html lang="nl"><head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="text/html; charset=utf-8" http-equiv="content-type">
<meta name="generator" content="ReSpec 32.1.10">
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;color:#000;box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;margin-top:.25em}
.dfn-panel ul a[href]{color:#333}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
  
  
  
  
  
  
<script>document.title = respecConfig.title</script>
<title>Guidelines for NL-GOV profile CloudEvents</title>
  
<title>Default</title>
  
<link rel="shortcut icon" type="image/x-icon" href="https://publicatie.centrumvoorstandaarden.nl/respec/style/logos/logius.ico">
  

<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
:is(h1,h2,h3,h4,h5,h6,a) abbr{border:none}
dfn{font-weight:700}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
code{color:#c63501}
th code{color:inherit}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
.toc a,.tof a{text-decoration:none}
a .figno,a .secno{color:#000}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
table.simple{border-spacing:0;border-collapse:collapse;border-bottom:3px solid #005a9c}
.simple th{background:#005a9c;color:#fff;padding:3px 5px;text-align:left}
.simple th a{color:#fff;padding:3px 5px;text-align:left}
.simple th[scope=row]{background:inherit;color:inherit;border-top:1px solid #ddd}
.simple td{padding:3px 10px;border-top:1px solid #ddd}
.simple tr:nth-child(even){background:#f0f6ff}
.section dd>p:first-child{margin-top:0}
.section dd>p:last-child{margin-bottom:0}
.section dd{margin-bottom:1em}
.section dl.attrs dd,.section dl.eldef dd{margin-bottom:0}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"§";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
<style>
ul.index{columns:30ch;column-gap:1.5em}
ul.index li{list-style:inherit}
ul.index li span{color:inherit;cursor:pointer;white-space:normal}
#index-defined-here ul.index li{font-size:.9rem}
ul.index code{color:inherit}
#index-defined-here .print-only{display:none}
@media print{
#index-defined-here .print-only{display:initial}
}
</style>
<style>
.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}
.hljs-comment,.hljs-quote{color:#717277;font-style:italic}
.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}
.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#ca4706;font-weight:700}
.hljs-literal{color:#0b76c5}
.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#42803c}
.hljs-built_in,.hljs-class .hljs-title{color:#9a6a01}
.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}
.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#336ae3}
.hljs-emphasis{font-style:italic}
.hljs-strong{font-weight:700}
.hljs-link{text-decoration:underline}
</style>
<style>
var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#000}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#000;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}
</style>
<script id="initialUserConfig" type="application/json">{
  "specStatus": "WV",
  "specType": "HR",
  "pubDomain": "notificatieservices",
  "shortName": "guidelines",
  "publishDate": "2022-06-24",
  "publishVersion": "0.3",
  "title": "Guidelines for NL-GOV profile CloudEvents",
  "editors": [
    {
      "name": "Gershon Jansen",
      "company": "VNG Realisatie",
      "companyURL": "https://www.vngrealisatie.nl/"
    },
    {
      "name": "Ad Gerrits",
      "company": "VNG Realisatie",
      "companyURL": "https://www.vngrealisatie.nl/"
    },
    {
      "name": "Edwin Wisse",
      "url": "https://logius.nl/standaarden",
      "company": "Logius"
    }
  ],
  "authors": [
    {
      "name": "Werkgroep Berichtenstandaard",
      "company": "Project Notificatieservices"
    }
  ],
  "subtitle": "Project Notificatieservices",
  "github": "https://github.com/Logius-standaarden/CloudEvents-NL-Guidelines",
  "addSectionLinks": true,
  "nl_addReleaseTagTitle": true,
  "nl_markdownEmbedImageInFigure": true,
  "alternateFormats": [
    {
      "label": "pdf",
      "uri": "CloudEvents-NL-Guidelines.pdf"
    }
  ],
  "nl_organisationName": "Logius",
  "nl_organisationStylesURL": "https://gitdocumentatie.logius.nl/publicatie/respec/style/",
  "nl_organisationPrefix": "LS-",
  "nl_organisationPublishURL": "https://gitdocumentatie.logius.nl/publicatie/",
  "nl_logo": {
    "src": "https://gitdocumentatie.logius.nl/publicatie/respec/style/logos/figure-logius.svg",
    "alt": "Logius",
    "id": "Logius",
    "height": 77,
    "width": 44,
    "url": "https://www.logius.nl/standaarden"
  },
  "localBiblio": {
    "SemVer": {
      "href": "https://semver.org",
      "title": "Semantic Versioning 2.0.0",
      "authors": [
        "T. Preston-Werner"
      ],
      "date": "June 2013"
    }
  },
  "publishISODate": "2022-06-24T00:00:00.000Z",
  "generatedSubtitle": "Werkversie 02 december 2022"
}</script>
<link rel="stylesheet" href="https://gitdocumentatie.logius.nl/publicatie/respec/style/LS-WV.css"></head>

<body class="h-entry toc-inline"><div class="head">
    <a class="logo" href="https://www.logius.nl/standaarden"><img alt="Logius" height="77" id="Logius" src="https://gitdocumentatie.logius.nl/publicatie/respec/style/logos/figure-logius.svg" width="44">
  </a> <h1 id="title" class="title">Guidelines for NL-GOV profile CloudEvents</h1>
    <h2 id="subtitle" class="subtitle">Project Notificatieservices</h2>
    <h2>
      Logius Handreiking<br>
      Werkversie
      <time class="dt-published" datetime="2022-06-24">02 december 2022</time>
    </h2>
    <dl>
      <dt>Deze versie:</dt><dd class="status">
              <a class="u-url status" href="https://logius-standaarden.github.io/CloudEvents-NL-Guidelines/">https://logius-standaarden.github.io/CloudEvents-NL-Guidelines/</a>
            </dd><dt>Laatst gepubliceerde versie:</dt><dd>
              <a href="https://gitdocumentatie.logius.nl/publicatie/notificatieservices/guidelines/">https://gitdocumentatie.logius.nl/publicatie/notificatieservices/guidelines/</a>
            </dd>
      <dt>Laatste werkversie:</dt><dd><a href="https://logius-standaarden.github.io/CloudEvents-NL-Guidelines/">https://logius-standaarden.github.io/CloudEvents-NL-Guidelines/</a></dd>
      
      
      
      
      
      <dt>Redacteurs:</dt>
      <dd class="editor p-author h-card vcard">
    <span class="p-name fn">Gershon Jansen</span> (<a class="p-org org h-org" href="https://www.vngrealisatie.nl/">VNG Realisatie</a>)
  </dd><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Ad Gerrits</span> (<a class="p-org org h-org" href="https://www.vngrealisatie.nl/">VNG Realisatie</a>)
  </dd><dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://logius.nl/standaarden">Edwin Wisse</a> (<span class="p-org org h-org">Logius</span>)
  </dd>
      
      <dt>Auteur:</dt><dd class="editor p-author h-card vcard">
    <span class="p-name fn">Werkgroep Berichtenstandaard</span> (<span class="p-org org h-org">Project Notificatieservices</span>)
  </dd>
      <dt>Doe mee:</dt><dd>
    <a href="https://github.com/Logius-standaarden/CloudEvents-NL-Guidelines/">GitHub Logius-standaarden/CloudEvents-NL-Guidelines</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/CloudEvents-NL-Guidelines/issues/">Dien een melding in</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/CloudEvents-NL-Guidelines/commits/">Revisiehistorie</a>
  </dd><dd>
    <a href="https://github.com/Logius-standaarden/CloudEvents-NL-Guidelines/pulls/">Pull requests</a>
  </dd>
    </dl>
    
    
    <p lang="en">
          This document is also available in this non-normative format:
          <a rel="alternate" href="CloudEvents-NL-Guidelines.pdf">pdf</a>
        </p>
    <p class="copyright" lang="en">
          This document is licensed under a
          <a rel="license" href="https://creativecommons.org/licenses/by/4.0/" class="subfoot">Creative Commons Attribution 4.0 License</a>.
        </p>
    <hr title="Separator for header">
  </div>
  <section id="abstract" class="introductory"><h2>Samenvatting</h2><h1>Abstract</h1>
</section>
  <section id="sotd" class="introductory"><h2>Status van dit document</h2>Dit is een werkversie die op elk moment kan worden gewijzigd, verwijderd of vervangen door andere documenten. Het is geen door het Technisch Overleg goedgekeurde consultatieversie.<p></p></section><nav id="toc"><h2 class="introductory" id="inhoudsopgave">Inhoudsopgave</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Samenvatting</a></li><li class="tocline"><a class="tocxref" href="#sotd">Status van dit document</a></li><li class="tocline"><a class="tocxref" href="#guideline-for-the-use-of-the-http-protocol-binding-for-cloudevents"><bdi class="secno">1. </bdi>Guideline for the use of the HTTP Protocol Binding for CloudEvents</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#summary-with-points-for-attention"><bdi class="secno">1.1 </bdi>Summary with points for attention</a></li><li class="tocline"><a class="tocxref" href="#recommendations"><bdi class="secno">1.2 </bdi>Recommendations</a></li><li class="tocline"><a class="tocxref" href="#examples"><bdi class="secno">1.3 </bdi>Examples</a></li><li class="tocline"><a class="tocxref" href="#normative-references"><bdi class="secno">1.4 </bdi>Normative References</a></li></ol></li><li class="tocline"><a class="tocxref" href="#guideline-for-the-use-of-the-json-event-format-for-cloudevents"><bdi class="secno">2. </bdi>Guideline for the use of the JSON Event Format for CloudEvents</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#summary-with-points-for-attention-0"><bdi class="secno">2.1 </bdi>Summary with points for attention</a></li><li class="tocline"><a class="tocxref" href="#recommendations-0"><bdi class="secno">2.2 </bdi>Recommendations</a></li><li class="tocline"><a class="tocxref" href="#examples-0"><bdi class="secno">2.3 </bdi>Examples</a></li><li class="tocline"><a class="tocxref" href="#normative-references-0"><bdi class="secno">2.4 </bdi>Normative References</a></li></ol></li><li class="tocline"><a class="tocxref" href="#guideline-for-the-use-of-the-webhook-pattern-for-cloudevents"><bdi class="secno">3. </bdi>Guideline for the use of the Webhook pattern for CloudEvents</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#summary-with-points-for-attention-1"><bdi class="secno">3.1 </bdi>Summary with points for attention</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#delivering-notifications"><bdi class="secno">3.1.1 </bdi>Delivering notifications</a></li><li class="tocline"><a class="tocxref" href="#authorization"><bdi class="secno">3.1.2 </bdi>Authorization</a></li><li class="tocline"><a class="tocxref" href="#abuse-protection"><bdi class="secno">3.1.3 </bdi>Abuse protection</a></li></ol></li><li class="tocline"><a class="tocxref" href="#recommendations-1"><bdi class="secno">3.2 </bdi>Recommendations</a></li><li class="tocline"><a class="tocxref" href="#examples-1"><bdi class="secno">3.3 </bdi>Examples</a></li><li class="tocline"><a class="tocxref" href="#normative-references-1"><bdi class="secno">3.4 </bdi>Normative References</a></li></ol></li><li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">4. </bdi>Conformiteit</a></li><li class="tocline"><a class="tocxref" href="#index"><bdi class="secno">A. </bdi>Index</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#index-defined-here"><bdi class="secno">A.1 </bdi>Begrippen gedefinieerd door deze specificatie</a></li><li class="tocline"><a class="tocxref" href="#index-defined-elsewhere"><bdi class="secno">A.2 </bdi>Begrippen gedefinieerd door verwijzing</a></li></ol></li></ol></nav>
  <section id="guideline-for-the-use-of-the-http-protocol-binding-for-cloudevents"><div class="header-wrapper"><h2 id="x1-guideline-for-the-use-of-the-http-protocol-binding-for-cloudevents"><bdi class="secno">1. </bdi>Guideline for the use of the HTTP Protocol Binding for CloudEvents</h2><a class="self-link" href="#guideline-for-the-use-of-the-http-protocol-binding-for-cloudevents" aria-label="Permalink for Section 1."></a></div>
<p>The CloudEvent-NL message format can be used when using different formats and protocols and patterns. In order to be able to use the GOV-NL profile properly in practice, agreements must also be made when and in what way a certain format, protocol or pattern is used. </p>
<p>The Serverless Working Group has described how the HTTP protocol can be used in a standardized way in combination with the CloudEvents message format: <a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-protocol-binding.md">HTTP Protocol Binding for CloudEvents</a>. The specification defines how the elements defined in the CloudEvents specification are to be used in HTTP 1.1 requests and response messages.</p>
<p>Similar to what happened in the NL GOV profile for the CloudEvents specification, this guideline makes recommendations about the use of the HTTP specification within the context of the Dutch government. These are intended to make use of the specification more unambiguous and to work towards standardisation in the long term.</p>
<section id="summary-with-points-for-attention"><div class="header-wrapper"><h3 id="x1-1-summary-with-points-for-attention"><bdi class="secno">1.1 </bdi>Summary with points for attention</h3><a class="self-link" href="#summary-with-points-for-attention" aria-label="Permalink for Section 1.1"></a></div>
<ul>
<li>Events can be transferred with all standard or application-defined HTTP request methods that support payload body transfers. Events can be also be transferred in HTTP responses and with all HTTP status codes that permit payload body transfers.</li>
<li>This specification defines three content modes for transferring events: <ul>
<li>structured (required): HTTP message body contains both event data and metadata attributes; an appropriate event format is used ((non-batching) JSON is the only event format that MUST be supported); </li>
<li>batched (optional): HTTP message body contains event data and metadata attributes from multiple events; an appropriate event format is used.</li>
<li>binary (required): HTTP message body contains event data as-is; event attributes mapped to HTTP-headers; HTTP <code>Content-Type</code> header declares the media type.</li>
</ul>
</li>
<li>Received <code>Content-Type</code> header value is:<ul>
<li><code>application/cloudevents(+xxxx)</code>: structured mode (<code>xxx</code> denotes the used event format)</li>
<li><code>application/cloudevents-batch</code>: batched mode</li>
<li>Otherwise: binary mode (<code>Content-Type</code> header declares the media type.)</li>
</ul>
</li>
<li>Structured content mode:<ul>
<li>The HTTP message body MUST contain both event data and metadata attributes.</li>
<li>The HTTP Content-Type header MUST be set to the media type of an event format (E.g. <code>application/cloudevents+json; charset=UTF-8</code>)</li>
<li>The chosen event format defines how all attributes, and data, are represented in the HTTP message body.</li>
<li>Implementations MAY include the same HTTP headers as defined for the binary mode (E.g. <code>ce-id</code>).</li>
</ul>
</li>
<li>Batched content mode:<ul>
<li>The HTTP message body MUST contain both event data and metadata attributes.</li>
<li>The HTTP Content-Type header MUST be set to the media type of an event format (E.g. <code>application/cloudevents-batch+json; charset=UTF-8</code>)</li>
<li>The chosen event format defines how a batch of events and all event attributes, and data, are represented.</li>
<li>All batched CloudEvents MUST have the same specversion attribute. Other attributes MAY differ, including the datacontenttype attribute. The batch MAY be empty.</li>
</ul>
</li>
<li>Binary content mode:<ul>
<li>All CloudEvents context attributes, including extensions, MUST be mapped to HTTP headers with the same name as the attribute name but prefixed with <code>ce-</code>.</li>
<li>The value for each HTTP header is constructed as described in the <a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-protocol-binding.md#3132-http-header-values">specification</a></li>
</ul>
</li>
</ul>
<p>At the moment there are <em>no additional agreements</em> about the use of the specification within the Dutch government.</p>
</section><section id="recommendations"><div class="header-wrapper"><h3 id="x1-2-recommendations"><bdi class="secno">1.2 </bdi>Recommendations</h3><a class="self-link" href="#recommendations" aria-label="Permalink for Section 1.2"></a></div>
<ul>
<li>One SHOULD use the <a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-protocol-binding.md">HTTP Protocol Binding for CloudEvents</a>. </li>
<li>There are no agreements to deviate from the standard in any part.</li>
<li>Given the fact that many organizations still have little experience with standardized exchange of events, we recommend a useful relatively simple mechanism that consumers are already familiar with:<ul>
<li>One SHOULD use structured content mode.</li>
<li>One SHOULD use the JSON (non batched) event format</li>
<li>When using structured mode one SHOULD NOT depend on the usage of HTTP-headers that replicate context-attributes in the event.</li>
</ul>
</li>
<li>If the above advice is followed, when notifying via webhooks 1 message will contain JSON-structured data about 1 event that has occurred.</li>
</ul>
</section><section id="examples"><div class="header-wrapper"><h3 id="x1-3-examples"><bdi class="secno">1.3 </bdi>Examples</h3><a class="self-link" href="#examples" aria-label="Permalink for Section 1.3"></a></div>
<p>Structured content mode: HTTP POST request with a JSON event format encoded event:</p>
<pre><code aria-busy="false" class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/myresource</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>webhook.example.com
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/cloudevents+json; charset=utf-8
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>nnnn

<span class="css">{
  "specversion": <span class="hljs-string">"1.0"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"nl.overheid.zaken.zaakstatus-gewijzigd"</span>,
  <span class="hljs-string">"source"</span>: <span class="hljs-string">"urn:nld:oin:00000001823288444000:systeem:BRP-component"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"f3dce042-cd6e-4977-844d-05be8dce7cea"</span>,
   ... further attributes omitted ...
  <span class="hljs-string">"data"</span>: {
        ... application data ...
  }
}
</span></code></pre>
<p>Batched content mode: HTTP POST request with two JSON event format encoded events:</p>
<pre><code aria-busy="false" class="hljs javascript">[
    {
        <span class="hljs-string">"specversion"</span>: <span class="hljs-string">"1.0"</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"nl.overheid.zaken.zaakstatus-gewijzigd"</span>,
        <span class="hljs-string">"source"</span>: <span class="hljs-string">"urn:nld:oin:00000001823288444000:systeem:BRP-component"</span>,
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"f3dce042-cd6e-4977-844d-05be8dce7cea"</span>,
        ... further attributes omitted ...
        <span class="hljs-string">"data"</span>: {
                ... application data ...
        }
    },
    {
        <span class="hljs-string">"specversion"</span>: <span class="hljs-string">"1.0"</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"nl.overheid.zaken.zaakstatus-gewijzigd"</span>,
        <span class="hljs-string">"source"</span>: <span class="hljs-string">"urn:nld:oin:00000001823288444000:systeem:BRP-component"</span>,
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"1ca55552-bc4a-4f5d-8cc8-8106e3e883c1"</span>,
        ... further attributes omitted ...
        <span class="hljs-string">"data"</span>: {
                ... application data ...
        }
    }
]
</code></pre>
<p>Binary content mode: HTTP POST request with context attributes mapped to HTTP-headers:</p>
<pre><code aria-busy="false" class="hljs">POST /myresource HTTP/1.1
Host: webhook.example.com
ce-specversion: 1.0
ce-type: nl.overheid.zaken.zaakstatus-gewijzigd
ce-id: f3dce042-cd6e-4977-844d-05be8dce7cea
ce-source: urn:nld:oin:00000001823288444000:systeem:BRP-component
... further attributes omitted ...
Content-Type: application/json; charset=utf-8
Content-Length: nnnn

{
    ... application data ...
}
</code></pre>
</section><section id="normative-references"><div class="header-wrapper"><h3 id="x1-4-normative-references"><bdi class="secno">1.4 </bdi>Normative References</h3><a class="self-link" href="#normative-references" aria-label="Permalink for Section 1.4"></a></div>
<ul>
<li><a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-protocol-binding.md">HTTP Protocol Binding for CloudEvents - Version 1.0.1</a></li>
</ul>
</section></section>--&gt;
  <section id="guideline-for-the-use-of-the-json-event-format-for-cloudevents"><div class="header-wrapper"><h2 id="x2-guideline-for-the-use-of-the-json-event-format-for-cloudevents"><bdi class="secno">2. </bdi>Guideline for the use of the JSON Event Format for CloudEvents</h2><a class="self-link" href="#guideline-for-the-use-of-the-json-event-format-for-cloudevents" aria-label="Permalink for Section 2."></a></div>
<p>The CloudEvent-NL message format can be used when using different formats and protocols and patterns. In order to be able to use the GOV-NL profile properly in practice, agreements must also be made when and in what way a certain format, protocol or pattern is used. </p>
<p>The Serverless Working Group has described how the JavaScript Object Notation (JSON) Data Interchange Format can be used in a standardized way in combination with the CloudEvents message format: <a href="https://github.com/cloudevents/spec/blob/v1.0.1/json-format.md">JSON Event Format for CloudEvents</a>.</p>
<p>Similar to what happened in the NL GOV profile for the CloudEvents specification, this guideline makes recommendations about the use of the JSON specification within the context of the Dutch government. These are intended to make use of the specification more unambiguous and to work towards standardisation in the long term.</p>
<p>The JSON Format for CloudEvents specification defines how events are expressed in JSON. The JSON syntax is not a specification of a complete data interchange. Meaningful data interchange requires agreement between a producer and consumer on the semantics attached to a particular use of the JSON syntax. What JSON does provide is the syntactic framework to which such semantics can be attached.</p>
<section id="summary-with-points-for-attention-0"><div class="header-wrapper"><h3 id="x2-1-summary-with-points-for-attention"><bdi class="secno">2.1 </bdi>Summary with points for attention</h3><a class="self-link" href="#summary-with-points-for-attention-0" aria-label="Permalink for Section 2.1"></a></div>
<ul>
<li>Each CloudEvents event can be wholly represented as a JSON object and MUST use the media type <code>application/cloudevents+json</code>.</li>
<li>The <a href="https://github.com/cloudevents/spec/blob/v1.0.1/spec.json">CloudEvents JSONSchema</a> for the spec can be used to validate events in JSON.</li>
<li>Unset attributes MAY be encoded to the JSON value of null. When decoding attributes and a null value is encountered, it MUST be treated as the equivalent of unset or omitted. OPTIONAL not omitted attributes MAY be represented as a null JSON value.</li>
<li>The runtime data type of the `data' content inside the JSON object can be either:<ul>
<li>a textual <a href="https://tools.ietf.org/html/rfc7159#section-3">JSON value</a> with member name <code>data</code></li>
<li>a binary JSON string expression containing the <a href="https://tools.ietf.org/html/rfc4648#section-4">Base64</a> encoded binary value with member name <code>data_base64</code></li>
</ul>
</li>
<li>So if a <code>data_base64</code> member is present it indicates that its value is Base64 encoded binary data.</li>
<li>JSON Batch Format can be used to batch several CloudEvents into a single JSON document.<ul>
<li>The document contains a JSON array filled with CloudEvents in the JSON Event format.</li>
<li>Media type <code>application/cloudevents-batch+json</code> MUST be used.</li>
<li>The JSON Batch Format MUST NOT be used when only support for the JSON Format is indicated.</li>
</ul>
</li>
</ul>
</section><section id="recommendations-0"><div class="header-wrapper"><h3 id="x2-2-recommendations"><bdi class="secno">2.2 </bdi>Recommendations</h3><a class="self-link" href="#recommendations-0" aria-label="Permalink for Section 2.2"></a></div>
<ul>
<li>One SHOULD use the <a href="https://github.com/cloudevents/spec/blob/v1.0.1/json-format.md">JSON Event Format for CloudEvents</a>. </li>
<li>There are no agreements to deviate from the standard in any part.</li>
<li>If applicable then one SHOULD use JSON as primary event format:<ul>
<li>JSON is the only event format that <a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-protocol-binding.md#14-event-formats">MUST be supported</a> when HTTP structured content mode is used.</li>
<li>JSON will be the primary format for APIs as formulated within the <a href="https://docs.geostandaarden.nl/api/vv-hr-API-Strategie-ext-20190715/#json">API strategie voor de Nederlandse overheid - Extensies</a>.</li>
</ul>
</li>
</ul>
</section><section id="examples-0"><div class="header-wrapper"><h3 id="x2-3-examples"><bdi class="secno">2.3 </bdi>Examples</h3><a class="self-link" href="#examples-0" aria-label="Permalink for Section 2.3"></a></div>
<p>Event with an attribute 'geheimnummer' having a null value and a 'data' attribute with a JSON value:</p>
<pre><code aria-busy="false" class="hljs json">{
  <span class="hljs-attr">"specversion"</span>: <span class="hljs-string">"1.0"</span>,
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"nl.overheid.zaken.zaakstatus-gewijzigd"</span>,
  <span class="hljs-attr">"source"</span>: <span class="hljs-string">"urn:nld:oin:00000001823288444000:systeem:BRP-component"</span>,
  <span class="hljs-attr">"subject"</span>: <span class="hljs-string">"123456789"</span>,
  <span class="hljs-attr">"id"</span>: <span class="hljs-string">"f3dce042-cd6e-4977-844d-05be8dce7cea"</span>,
  <span class="hljs-attr">"time"</span>: <span class="hljs-string">"2021-12-10T17:31:00Z"</span>,
  <span class="hljs-attr">"nlbrpnationaliteit"</span>: <span class="hljs-string">"0083"</span>,
  <span class="hljs-attr">"geheimnummer"</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">"dataref"</span>: <span class="hljs-string">"https://gemeenteX/api/persoon/123456789"</span>,
  <span class="hljs-attr">"sequence"</span>: <span class="hljs-string">"1234"</span>,
  <span class="hljs-attr">"sequencetype"</span>: <span class="hljs-string">"integer"</span>,
  <span class="hljs-attr">"datacontenttype"</span>: <span class="hljs-string">"application/json"</span>,
  <span class="hljs-attr">"data"</span>: {
    <span class="hljs-attr">"bsn"</span>: <span class="hljs-string">"1234567789"</span>,
    <span class="hljs-attr">"naam"</span>: <span class="hljs-string">"Jan Jansen"</span>,
    <span class="hljs-attr">"gecontroleerd"</span>: <span class="hljs-string">"ja"</span>
  }
}
</code></pre>
<p>Event with both the attribute 'datacontenttype' and 'data_base64' and a JSON string expression with Base64 encoded binary data as value of the 'data_base64' attribute:</p>
<pre><code aria-busy="false" class="hljs json">{
  <span class="hljs-attr">"specversion"</span>: <span class="hljs-string">"1.0"</span>,
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"nl.overheid.zaken.zaakstatus-gewijzigd"</span>,
  <span class="hljs-attr">"source"</span>: <span class="hljs-string">"urn:nld:oin:00000001823288444000:systeem:BRP-component"</span>,
  <span class="hljs-attr">"id"</span>: <span class="hljs-string">"f3dce042-cd6e-4977-844d-05be8dce7cea"</span>,
  <span class="hljs-attr">"datacontenttype"</span>: <span class="hljs-string">"application/vnd.apache.thrift.binary"</span>,
  <span class="hljs-attr">"data_base64"</span>: <span class="hljs-string">"YWFwIG5vb3QgbWllcw=="</span>
}
</code></pre>
<p>Event with only the attribute 'data_base64' and a JSON string expression with Base64 encoded binary data as value of the 'data_base64' attribute:</p>
<pre><code aria-busy="false" class="hljs json">{
  <span class="hljs-attr">"specversion"</span>: <span class="hljs-string">"1.0"</span>,
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"nl.overheid.zaken.zaakstatus-gewijzigd"</span>,
  <span class="hljs-attr">"source"</span>: <span class="hljs-string">"urn:nld:oin:00000001823288444000:systeem:BRP-component"</span>,
  <span class="hljs-attr">"id"</span>: <span class="hljs-string">"f3dce042-cd6e-4977-844d-05be8dce7cea"</span>,
  <span class="hljs-attr">"data_base64"</span> : <span class="hljs-string">"YWFwIG5vb3QgbWllcw=="</span>
}
</code></pre>
</section><section id="normative-references-0"><div class="header-wrapper"><h3 id="x2-4-normative-references"><bdi class="secno">2.4 </bdi>Normative References</h3><a class="self-link" href="#normative-references-0" aria-label="Permalink for Section 2.4"></a></div>
<ul>
<li><a href="https://github.com/cloudevents/spec/blob/v1.0.1/json-format.md">JSON Event Format for CloudEvents - Version 1.0.1</a></li>
</ul>
</section></section>--&gt;
  <section id="guideline-for-the-use-of-the-webhook-pattern-for-cloudevents"><div class="header-wrapper"><h2 id="x3-guideline-for-the-use-of-the-webhook-pattern-for-cloudevents"><bdi class="secno">3. </bdi>Guideline for the use of the Webhook pattern for CloudEvents</h2><a class="self-link" href="#guideline-for-the-use-of-the-webhook-pattern-for-cloudevents" aria-label="Permalink for Section 3."></a></div>
<p>The CloudEvent-NL message format can be used when using different formats and protocols and patterns. In order to be able to use the GOV-NL profile properly in practice, agreements must also be made when and in what way a certain format, protocol or pattern is used. </p>
<p>The Serverless Working Group has described how the Webhook pattern can be used in a standardized way in combination with the CloudEvents message format: <a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-webhook.md">HTTP 1.1 Web Hooks for Event Delivery</a>.</p>
<p>"Webhooks" are a popular pattern to deliver notifications between applications and via HTTP endpoints. Applications that make notifications available, allow for other applications to register an HTTP endpoint to which notifications are delivered. In spite of pattern usage being widespread, there is no formal definition for Web Hooks. The CloudEvents specification now provides such a definition for use with CNCF CloudEvents (but is considered generally usable beyond the scope of CloudEvents).</p>
<p>Similar to what happened in the 'NL GOV profile for the CloudEvents' specification, this guideline makes recommendations about the use of the drafted CloudEvents specification within the context of the Dutch government. These are intended to make use of the specification more unambiguous and to work towards standardisation in the long term.</p>
<section id="summary-with-points-for-attention-1"><div class="header-wrapper"><h3 id="x3-1-summary-with-points-for-attention"><bdi class="secno">3.1 </bdi>Summary with points for attention</h3><a class="self-link" href="#summary-with-points-for-attention-1" aria-label="Permalink for Section 3.1"></a></div>
<p>The 'HTTP 1.1 Web Hooks for Event Delivery' specification prescribes rules constraining the use and handling of specific HTTP methods and headers and defines:</p>
<ol>
<li>a HTTP method by how notifications are delivered by the sender</li>
<li>an authorization model for event delivery to protect the delivery target</li>
<li>a registration handshake that protects the sender from being abused for flooding arbitrary HTTP sites with requests.
For each of the mechanisms it is described which agreements apply to both sender and receiver.
The specification</li>
</ol>
<section id="delivering-notifications"><div class="header-wrapper"><h4 id="x3-1-1-delivering-notifications"><bdi class="secno">3.1.1 </bdi>Delivering notifications</h4><a class="self-link" href="#delivering-notifications" aria-label="Permalink for Section 3.1.1"></a></div>
<ul>
<li>A delivery request MUST use a HTTP POST request via HTTPS.</li>
<li>A delivery response MUST have the appropriate status code:<ul>
<li>200 OK of 200 Created if delivery had been accepted and processed and response carries a payload</li>
<li>201 Created of 204 No Content when accepted and processed but carries no payload </li>
<li>202 Accepted if accepted but not yet processed or processing status is unknown</li>
<li>410 Gone if delivery target has been retired</li>
<li>429 Too Many Requests when exceeding a request rate limit and MUST include the Retry-After header.</li>
<li>415 Unsupported Media Type wehen notification format is not understood.</li>
<li>other error status codes apply as specified in <a href="https://tools.ietf.org/html/rfc7231">RFC7231</a>.</li>
</ul>
</li>
</ul>
</section><section id="authorization"><div class="header-wrapper"><h4 id="x3-1-2-authorization"><bdi class="secno">3.1.2 </bdi>Authorization</h4><a class="self-link" href="#authorization" aria-label="Permalink for Section 3.1.2"></a></div>
<p>The delivery request MUST use one of the following two methods (both of which lean on the OAuth 2.0 Bearer Token <a href="https://tools.ietf.org/html/rfc6750">RFC6750</a> model):</p>
<ul>
<li>The access token is sent in the Authorization request header field; for <a href="https://tools.ietf.org/html/rfc6750#section-2.1">OAuth 2.0 Bearer</a> tokens, the "Bearer" scheme MUST be used.</li>
<li>The access token is added to the HTTP Request URI Query component as described in <a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-webhook.md#32-uri-query-parameter">URI Query Parameter</a>.</li>
</ul>
</section><section id="abuse-protection"><div class="header-wrapper"><h4 id="x3-1-3-abuse-protection"><bdi class="secno">3.1.3 </bdi>Abuse protection</h4><a class="self-link" href="#abuse-protection" aria-label="Permalink for Section 3.1.3"></a></div>
<p>It must be prevented that notifications are sent to recipients who have not requested this themselves. A legitimate delivery target needs to indicate that it agrees with notifications being delivered to it. Reaching the delivery agreement is realized using a validation handshake:</p>
<ul>
<li><p>A handshake can either be executed immediately at registration time or as a "pre-flight" request immediately preceding a delivery.</p>
</li>
<li><p>Delivery targets SHOULD support the abuse protection feature. If a target does not support the feature, the sender MAY choose not to send to the target, at all, or send only at a very low request rate.</p>
</li>
<li><p>The <em>validation request</em> uses the HTTP <a href="https://tools.ietf.org/html/rfc7231#section-4.3.7">OPTIONS</a> method with header fields:</p>
<ul>
<li>WebHook-Request-Origin (required):  a DNS expression that identifies the sending system</li>
<li>WebHook-Request-Callback (optional): a callback URL that allows the delivery target to grant send permission asynchronously, via a simple HTTPS callback.</li>
<li>WebHook-Request-Rate (optional): a positive integer number that expresses the request rate in "requests per minute"</li>
</ul>
</li>
<li><p>The <em>validation respons</em> MUST be sent if the delivery target does allow delivery of events with header fields:</p>
<ul>
<li>WebHook-Allowed-Origin (required): MUST either be the origin name supplied in the WebHook-Request-Origin header, or a singular asterisk character ('*'), indicating that the delivery target supports notifications from all origins.</li>
<li>WebHook-Allowed-Rate (depends): MUST be returned if the request contained the WebHook-Request-Rate, otherwise it SHOULD be returned; an integer number expresses the permitted request rate in "requests per minute" or asterisk when there is no rate limitation.</li>
</ul>
</li>
</ul>
</section></section><section id="recommendations-1"><div class="header-wrapper"><h3 id="x3-2-recommendations"><bdi class="secno">3.2 </bdi>Recommendations</h3><a class="self-link" href="#recommendations-1" aria-label="Permalink for Section 3.2"></a></div>
<ul>
<li>One SHOULD use the  <a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-webhook.md">HTTP 1.1 Web Hooks for Event Delivery</a>. </li>
<li>There are no agreements to deviate from the standard in any part.</li>
<li>As described in the specification usage of an access token added to the HTTP Request URI Query component has a number of security weaknesses and therefore SHOULD NOT be used unless it is impossible to sent an access token in the Authorization request header field.</li>
<li>The CloudEvents specification focuses on automated validation of intended notification applications. Within the context of the Dutch government, there can (also) be non-automated validation (e.g. by specifying endpoints in agreements between the organizations involved). In those cases it is not always necessary to perform an automated handshake before notifications may be sent.</li>
<li>An automated handshake as described can take place at different moments. If automated subscription to event notification is used:<ul>
<li>one SHOULD perform a handshake as described in the specification immediately at registration time</li>
<li>one MAY perform a handshake as a "pre-flight" request immediately preceding a delivery.</li>
</ul>
</li>
</ul>
</section><section id="examples-1"><div class="header-wrapper"><h3 id="x3-3-examples"><bdi class="secno">3.3 </bdi>Examples</h3><a class="self-link" href="#examples-1" aria-label="Permalink for Section 3.3"></a></div>
<p>Validation request:</p>
<pre><code aria-busy="false" class="hljs http"><span class="hljs-keyword">OPTIONS</span> <span class="hljs-string">/endpoint</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>webhook.example.com
<span class="hljs-attribute">WebHook-Request-Origin</span><span class="hljs-punctuation">: </span>eventemitter.example.com
<span class="hljs-attribute">WebHook-Request-Callback</span><span class="hljs-punctuation">: </span>https://example.com/confirm?id=12345&amp;key=...base64..
<span class="hljs-attribute">WebHook-Request-Rate</span><span class="hljs-punctuation">: </span>120
</code></pre>
<p>Validation response:</p>
<pre><code aria-busy="false" class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Allow</span><span class="hljs-punctuation">: </span>GET,POST,PUT,PATCH,DELETE,HEAD,OPTIONS
<span class="hljs-attribute">Access-Control-Allow-Origin</span><span class="hljs-punctuation">: </span>https://eventemitter.example.com
<span class="hljs-attribute">Access-Control-Allow-Methods</span><span class="hljs-punctuation">: </span>GET,POST,PUT,PATCH,DELETE,HEAD,OPTIONS
<span class="hljs-attribute">Access-Control-Allow-Headers</span><span class="hljs-punctuation">: </span>Content-Type 
<span class="hljs-attribute">WebHook-Allowed-Origin</span><span class="hljs-punctuation">: </span>eventemitter.example.com
<span class="hljs-attribute">WebHook-Allowed-Rate</span><span class="hljs-punctuation">: </span>120
</code></pre>
<p>Delivery request: </p>
<ul>
<li><a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-protocol-binding.md#32-structured-content-mode">HTTP structured content mode</a> with a</li>
<li><a href="https://github.com/cloudevents/spec/blob/v1.0.1/json-format.md">JSON event format</a> encoded event with a</li>
<li><a href="https://tools.ietf.org/html/rfc6750#section-2.1">OAuth 2.0 Bearer</a> token</li>
</ul>
<pre><code aria-busy="false" class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/myresource</span> <span class="hljs-meta">HTTP/1.1</span>
<span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>server.example.com
<span class="hljs-attribute">Authorization</span><span class="hljs-punctuation">: </span>Bearer mF_9.B5f-4.1JqM
<span class="hljs-attribute">WebHook-Request-Origin</span><span class="hljs-punctuation">: </span>eventemitter.example.com
<span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/cloudevents+json; charset=utf-8
<span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>nnnn

<span class="css">{
  "specversion": <span class="hljs-string">"1.0"</span>,
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"nl.overheid.zaken.zaakstatus-gewijzigd"</span>,
  <span class="hljs-string">"source"</span>: <span class="hljs-string">"urn:nld:oin:00000001823288444000:systeem:BRP-component"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"f3dce042-cd6e-4977-844d-05be8dce7cea"</span>,
   ... further attributes omitted ...
}
</span></code></pre>
<p>Delivery response:</p>
<pre><code aria-busy="false" class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">204</span> No Content
</code></pre>
</section><section id="normative-references-1"><div class="header-wrapper"><h3 id="x3-4-normative-references"><bdi class="secno">3.4 </bdi>Normative References</h3><a class="self-link" href="#normative-references-1" aria-label="Permalink for Section 3.4"></a></div>
<ul>
<li><a href="https://github.com/cloudevents/spec/blob/v1.0.1/http-webhook.md">HTTP 1.1 Web Hooks for Event Delivery - Version 1.0.1</a></li>
</ul>
</section></section>
  
  <section id="conformance"><div class="header-wrapper"><h2 id="x4-conformiteit"><bdi class="secno">4. </bdi>Conformiteit</h2><a class="self-link" href="#conformance" aria-label="Permalink for Section 4."></a></div><p>Naast onderdelen die als niet normatief gemarkeerd zijn, zijn ook alle diagrammen, voorbeelden, en noten in dit document niet normatief. Verder is alles in dit document normatief.</p></section>
  <section id="tof"></section>
  <section id="index" class="appendix"><div class="header-wrapper"><h2 id="a-index"><bdi class="secno">A. </bdi>Index</h2><a class="self-link" href="#index" aria-label="Permalink for Appendix A."></a></div><section id="index-defined-here">
    <div class="header-wrapper"><h3 id="a-1-begrippen-gedefinieerd-door-deze-specificatie"><bdi class="secno">A.1 </bdi>Begrippen gedefinieerd door deze specificatie</h3><a class="self-link" href="#index-defined-here" aria-label="Permalink for Appendix A.1"></a></div>
    <ul class="index">
    
  </ul>
  </section><section id="index-defined-elsewhere">
    <div class="header-wrapper"><h3 id="a-2-begrippen-gedefinieerd-door-verwijzing"><bdi class="secno">A.2 </bdi>Begrippen gedefinieerd door verwijzing</h3><a class="self-link" href="#index-defined-elsewhere" aria-label="Permalink for Appendix A.2"></a></div>
    <ul class="index">
    
  </ul>
  </section></section>



<p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">↑</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>